<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🌟 철학적 동반자</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #4a5568;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .header p {
            color: #718096;
            font-size: 1rem;
        }

        .menu {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }

        .menu-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 20px;
            border-radius: 15px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .menu-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .content {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .content.active {
            display: block;
        }

        .question-section {
            margin-bottom: 25px;
        }

        .question-section h3 {
            color: #4a5568;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 500;
        }

        .input-group input,
        .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .result-section {
            background: #f7fafc;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 4px solid #667eea;
        }

        .philosopher-quote {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            text-align: center;
        }

        .philosopher-quote .name {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .philosopher-quote .quote {
            font-style: italic;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .philosopher-quote .context {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .action-button {
            background: #48bb78;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1rem;
            cursor: pointer;
            margin-right: 10px;
            margin-top: 10px;
            transition: background 0.3s ease;
        }

        .action-button:hover {
            background: #38a169;
        }

        .back-button {
            background: #718096;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 20px;
            transition: background 0.3s ease;
        }

        .back-button:hover {
            background: #4a5568;
        }

        .pattern-list {
            max-height: 300px;
            overflow-y: auto;
            background: #f7fafc;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .pattern-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #ambientMessage {
            transition: opacity 0.5s ease-in-out;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .card {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <!-- 메인 메뉴 -->
            <div id="mainMenu" class="content active">
                <div class="header">
                    <h1>🌟 철학적 동반자</h1>
                    <p>혼자가 아니에요. 함께 생각해봐요.</p>
                </div>
                
                <!-- 캐릭터 알림 영역 -->
                <div id="characterNotification" style="display: none; margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, #fef5e7 0%, #fff2d9 100%); border: 2px solid #f6ad55; border-radius: 15px; padding: 20px; text-align: center; animation: fadeIn 0.5s ease-in;">
                        <div id="notificationContent"></div>
                    </div>
                </div>
                
                <div class="menu">
                    <button class="menu-button" onclick="showCompanionMeeting()">
                        🌟 오늘의 동반자 만나기
                    </button>
                    <button class="menu-button" onclick="showDiary()">
                        💭 오늘의 마음 적기
                    </button>
                    <button class="menu-button" onclick="showCompanionHistory()">
                        📖 내 동반자 기록 보기
                    </button>
                    
                    <!-- 함께 시간 보내기 섹션 -->
                    <div style="margin: 20px 0; text-align: center; color: #667eea; font-size: 0.9rem;">
                        💫 함께 시간 보내기
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button class="menu-button" onclick="startAmbientTime('bada')" style="font-size: 0.9rem; padding: 15px;">
                            🪷 바다와 함께
                        </button>
                        <button class="menu-button" onclick="startAmbientTime('quest')" style="font-size: 0.9rem; padding: 15px;">
                            🔍 퀘스트와 함께
                        </button>
                        <button class="menu-button" onclick="startAmbientTime('zero')" style="font-size: 0.9rem; padding: 15px;">
                            🌊 제로와 함께
                        </button>
                        <button class="menu-button" onclick="startAmbientTime('flame')" style="font-size: 0.9rem; padding: 15px;">
                            🔥 플레임과 함께
                        </button>
                        <button class="menu-button" onclick="startAmbientTime('stone')" style="font-size: 0.9rem; padding: 15px; grid-column: 1 / -1;">
                            🗿 스톤과 함께
                        </button>
                    </div>
                    
                    <button class="menu-button" onclick="showDailyDiscoveries()">
                        🌱 일상의 작은 발견들
                    </button>
                    <button class="menu-button" onclick="showAbout()">
                        ℹ️ 이 프로그램에 대해
                    </button>
                </div>
            </div>


            <!-- 캐릭터 만나기 -->
            <div id="characterMeeting" class="content">
                <div class="header">
                    <h1 id="characterName">🪷 바다</h1>
                    <p id="characterPersonality">평온하고 따뜻한 마음을 가진 친구</p>
                    <div id="intimacyDisplay" style="margin-top: 15px;"></div>
                </div>
                
                <div id="characterResult"></div>
                <button class="back-button" onclick="showMainMenu()">← 메인으로 돌아가기</button>
            </div>

            <!-- 캐릭터와 함께 시간 보내기 -->
            <div id="ambientTime" class="content">
                <div class="header">
                    <h1 id="ambientCharacterName">🪷 바다와 함께</h1>
                    <p id="ambientCharacterDesc">평온한 시간을 함께 보내요</p>
                </div>
                
                <div class="result-section" style="text-align: center; margin-bottom: 30px;">
                    <div id="ambientCharacterEmoji" style="font-size: 4rem; margin-bottom: 20px;">🪷</div>
                    
                    <div style="background: #f7fafc; padding: 20px; border-radius: 15px; margin-bottom: 25px;">
                        <h3 id="ambientMusicTitle" style="color: #4a5568; margin-bottom: 10px;">🎵 평온한 연못가</h3>
                        <p id="ambientMusicDesc" style="color: #718096; margin-bottom: 15px;">잔잔한 빗소리와 자연의 소리로 마음을 평안하게 해드려요</p>
                        <a id="ambientMusicLink" href="#" target="_blank" class="action-button" style="text-decoration: none; display: inline-block;">
                            🎬 테마곡 듣기
                        </a>
                    </div>
                    
                    <div id="ambientMessageArea" style="min-height: 100px; display: flex; align-items: center; justify-content: center;">
                        <div id="ambientMessage" style="font-style: italic; color: #667eea; font-size: 1.1rem; background: #f0f8ff; padding: 20px; border-radius: 15px; border-left: 4px solid #667eea;">
                            함께 있는 것만으로도 충분해요. 편안히 쉬어가세요.
                        </div>
                    </div>
                    
                    <div style="margin-top: 25px; color: #718096; font-size: 0.9rem;">
                        💫 <span id="ambientTimer">00:00</span> 함께하고 있어요
                    </div>
                </div>
                
                <button class="back-button" onclick="leaveAmbientTime()">← 나가기</button>
            </div>

            <!-- 동반자 만나기 -->
            <div id="companionMeeting" class="content">
                <div class="header">
                    <h1>🌟 오늘의 동반자</h1>
                    <p>지금 어떤 상황인가요?</p>
                </div>
                
                <div class="menu">
                    <button class="menu-button" onclick="meetCompanion('lonely')">
                        외롭고 막막해요
                    </button>
                    <button class="menu-button" onclick="meetCompanion('tired')">
                        힘들고 지쳐요
                    </button>
                    <button class="menu-button" onclick="meetCompanion('confused')">
                        뭘 해야 할지 모르겠어요
                    </button>
                    <button class="menu-button" onclick="meetCompanion('random')">
                        그냥 누군가 만나고 싶어요
                    </button>
                </div>

                <div id="companionResult"></div>
                <button class="back-button" onclick="showMainMenu()">← 메인으로 돌아가기</button>
            </div>

            <!-- 동반자 히스토리 -->
            <div id="companionHistory" class="content">
                <div class="header">
                    <h1>📖 내 동반자 기록</h1>
                    <p>지금까지 만났던 동반자들</p>
                </div>
                
                <div id="historyContainer">
                    <div class="pattern-list" id="companionList"></div>
                </div>

                <button class="back-button" onclick="showMainMenu()">← 메인으로 돌아가기</button>
            </div>

            <!-- 감정 일기 -->
            <div id="diary" class="content">
                <div class="header">
                    <h1>💭 오늘의 마음</h1>
                    <p>솔직한 마음을 적어보세요. 누군가 들어줄 거예요.</p>
                </div>
                
                <div class="input-group">
                    <label for="diaryText">오늘 기분이 어떠세요?</label>
                    <textarea id="diaryText" rows="5" placeholder="힘들거나 좋거나, 어떤 마음이든 자유롭게 적어보세요...&#10;&#10;예시:&#10;- 오늘 너무 피곤하고 무기력해&#10;- 뭔가 불안하고 막막한 느낌이야&#10;- 생각이 많아서 잠이 안 와&#10;- 그냥 누군가랑 대화하고 싶어" style="resize: vertical; min-height: 120px;"></textarea>
                </div>
                
                <button class="action-button" onclick="submitDiary()" style="width: 100%; margin-bottom: 15px;">
                    💝 마음 전하기
                </button>
                
                <div id="diaryResponse"></div>
                
                <button class="back-button" onclick="showMainMenu()">← 메인으로 돌아가기</button>
            </div>

            <!-- 일상의 작은 발견들 -->
            <div id="dailyDiscoveries" class="content">
                <div class="header">
                    <h1>🌱 일상의 작은 발견들</h1>
                    <p>캐릭터들이 오늘 경험한 소소한 이야기들</p>
                </div>
                
                <div id="discoveryContainer">
                    <!-- 발견 목록이 여기에 표시됩니다 -->
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="action-button" onclick="loadNewDiscoveries()">
                        🔄 새로운 발견 불러오기
                    </button>
                </div>
                
                <button class="back-button" onclick="showMainMenu()">← 메인으로 돌아가기</button>
            </div>

            <!-- 프로그램 정보 -->
            <div id="about" class="content">
                <div class="header">
                    <h1>ℹ️ 철학적 동반자에 대해</h1>
                    <p>안전하고 따뜻한 공간을 만들기 위해</p>
                </div>
                
                <div class="result-section">
                    <h3>🎯 이 프로그램의 목적</h3>
                    <p>외롭고 막막한 순간에 혼자가 아님을 느끼게 해주는 것입니다. 철학자들과 좋아하는 캐릭터들의 지혜를 통해 작은 위로와 동기를 얻을 수 있습니다.</p>
                    
                    <h3>🔒 개인정보 보호</h3>
                    <p><strong>✅ 모든 데이터는 본인 기기에만 저장됩니다.</strong></p>
                    <p>• 서버에 전송되지 않음</p>
                    <p>• 개발자도 접근할 수 없음</p>
                    <p>• 브라우저 로컬 스토리지만 사용</p>
                    <p>• 삭제하려면 브라우저 데이터 삭제하면 됨</p>
                    
                    <h3>🛡️ 안전한 메시지 시스템</h3>
                    <p><strong>완전 익명제로 운영됩니다.</strong></p>
                    <p>• 닉네임, 아이디 없음</p>
                    <p>• 전화번호, 카톡ID 등 연락처 자동 차단</p>
                    <p>• "만나요", "연락해요" 등 만남 관련 내용 차단</p>
                    <p>• 오직 따뜻한 격려 메시지만 공유 가능</p>
                    
                    <h3>💡 사용 팁</h3>
                    <p>• 매일 5분씩만 사용해도 효과적입니다</p>
                    <p>• 솔직한 마음으로 동반자를 만나보세요</p>
                    <p>• 완벽한 답을 찾으려 하지 마세요</p>
                    <p>• 작은 변화도 소중히 여기세요</p>
                    
                    <h3>⚠️ 주의사항</h3>
                    <p>• 심각한 우울감이나 자해 충동이 있다면 전문가의 도움을 받으세요</p>
                    <p>• 정신건강 상담: 1393 (24시간)</p>
                    <p>• 생명의전화: 1588-9191</p>
                    <p>• 청소년 상담: 1388</p>
                    
                    <h3>🤝 만든 이유</h3>
                    <p>개발자도 비슷한 경험을 했습니다. 혼자 있을 때 작은 위로라도 있으면 좋겠다는 마음으로 만들었습니다. 상업적 목적이 아닌, 진심으로 도움이 되고 싶어서 만든 프로그램입니다.</p>
                    
                    <h3>📝 오픈소스</h3>
                    <p>이 프로그램은 HTML 파일 하나로 이루어져 있어 누구나 코드를 확인할 수 있습니다. 의심스러운 부분이 있다면 언제든 확인해보세요.</p>
                    
                    <p style="text-align: center; margin-top: 30px; font-style: italic; color: #667eea;">
                        💙 혼자가 아니에요. 함께 있어요. 💙
                    </p>
                </div>

                <button class="back-button" onclick="showMainMenu()">← 메인으로 돌아가기</button>
            </div>
        </div>
    </div>

    <script>
        // 가상 캐릭터 데이터 (철학자 모티브)
        const characters = {
            bada: {
                name: "바다",
                emoji: "🪷",
                type: "마음의 친구",
                personality: "평온하고 따뜻한 마음을 가진 친구",
                intimacy: parseInt(localStorage.getItem('intimacy_bada') || '0'),
                themeMusic: {
                    title: "평온한 연못가",
                    url: "https://www.youtube.com/watch?v=j3X7vhvqi_E", // Rain on Leaves - Relaxing Nature Sounds
                    description: "잔잔한 빗소리와 자연의 소리로 마음을 평안하게 해드려요"
                },
                ambientMessages: [
                    "지금 이 순간, 마음이 편안해지고 있나요?",
                    "천천히 숨을 쉬어보세요. 급할 것 없어요.",
                    "이 평온함 속에서 내면의 소리를 들어보세요.",
                    "잠시 모든 걱정을 내려놓고 지금 여기에 있어주세요.",
                    "물방울이 떨어지는 소리처럼, 마음의 평화도 자연스럽게 찾아와요."
                ],
                dailyDiscoveries: {
                    morning: [
                        "아침에 창문을 열었더니 이슬이 정말 예쁘게 맺혀있더라고요. 작은 구슬 같았어요.",
                        "오늘 새벽에 새들이 지저귀는 소리를 들었는데, 마치 하루를 축복해주는 것 같았어요.",
                        "커피 향이 집안에 퍼지는 순간이 있잖아요? 그 따뜻함이 마음까지 감싸주는 것 같아요."
                    ],
                    afternoon: [
                        "점심 후 잠깐 산책을 했는데, 나무 그림자가 땅에 그려놓은 패턴이 참 신기했어요.",
                        "햇살이 창문을 통해 들어와 바닥에 사각형을 그려놓는 걸 보니 평범한 것도 예술이 되는구나 싶었어요.",
                        "오늘 구름 모양이 정말 재미있더라고요. 잠깐 멈춰서 바라보니 마음이 한결 가벼워졌어요."
                    ],
                    evening: [
                        "저녁노을 색깔이 정말 따뜻하더라고요. 오렌지와 분홍이 섞인 그 색감을 어떻게 설명해야 할까요?",
                        "집에 돌아오는 길에 가로등이 하나둘 켜지는 모습을 보니, 하루가 조용히 마무리되는 기분이었어요.",
                        "창가에 앉아 차를 마시며 밖을 내다보니, 이런 소소한 시간이 얼마나 소중한지 느꼈어요."
                    ]
                },
                dialogues: {
                    0: {
                        greeting: "안녕하세요. 저는 바다예요. 처음 뵙네요.",
                        quote: "모든 고통에는 끝이 있어요. 지금 이 순간만 견디면 돼요.",
                        book: "작은 부처 - 타드 차이알롱코른",
                        music: "River Flows in You - Yiruma",
                        youtube: "https://www.youtube.com/watch?v=7maJOI3QMu0"
                    },
                    3: {
                        greeting: "다시 만나서 반가워요. 오늘은 어떤 하루였나요?",
                        quote: "완벽하지 않아도 괜찮아요. 있는 그대로의 당신이 소중해요.",
                        book: "마음챙김의 기적 - 틱낫한",
                        music: "Weightless - Marconi Union",
                        youtube: "https://www.youtube.com/watch?v=UfcAVejslrU",
                        special: "우리 이제 좀 친해진 것 같아요. 편안한 마음으로 이야기해봐요."
                    },
                    15: {
                        greeting: "소중한 친구여, 오늘도 함께할 수 있어서 감사해요.",
                        quote: "깨달음은 멀리 있지 않아요. 지금 여기, 당신 안에 있어요.",
                        book: "지금 이 순간을 살아라 - 에크하르트 톨레",
                        music: "Inner Peace - Meditation Music",
                        youtube: "https://www.youtube.com/watch?v=5QzrLW-2Dbg",
                        special: "당신과 함께하는 이 시간들이 정말 소중해요. 우리는 서로의 거울이 되어주고 있어요."
                    }
                }
            },
            quest: {
                name: "퀘스트",
                emoji: "🔍",
                type: "호기심 많은 친구",
                personality: "질문하는 것을 좋아하는 사색하는 친구",
                intimacy: parseInt(localStorage.getItem('intimacy_quest') || '0'),
                themeMusic: {
                    title: "사색의 도서관",
                    url: "https://www.youtube.com/watch?v=DWcJFNfaw9c", // Classical Study Music
                    description: "깊은 사색을 위한 클래식 피아노 선율"
                },
                ambientMessages: [
                    "지금 어떤 생각이 떠오르고 있나요?",
                    "오늘 새롭게 궁금해진 것이 있나요?",
                    "이 조용한 시간 속에서 마음의 질문에 귀 기울여보세요.",
                    "모든 답은 이미 당신 안에 있어요. 찾기만 하면 돼요.",
                    "지혜는 급하게 찾는 것이 아니라 천천히 우러나는 거예요."
                ],
                dailyDiscoveries: {
                    morning: [
                        "오늘 아침에 문득 '왜 사람들은 인사를 할까?'라는 생각이 들었어요. 간단한 것 같지만 깊이 있는 질문이더라고요.",
                        "커피를 마시다가 '이 맛을 처음 발견한 사람은 어떤 기분이었을까?' 궁금해졌어요.",
                        "길을 걷다가 개미들이 줄지어 가는 걸 봤는데, 그들만의 소통 방식이 정말 신기하더라고요."
                    ],
                    afternoon: [
                        "도서관에서 책을 읽다가 '왜 어떤 문장은 마음에 오래 남을까?'라는 궁금증이 생겼어요.",
                        "점심을 먹으면서 '맛이란 게 과연 객관적일까, 주관적일까?' 생각해봤어요. 흥미로운 주제죠?",
                        "사람들이 걷는 모습을 보다가 '걸음걸이가 그 사람의 성격을 보여줄까?' 궁금해졌어요."
                    ],
                    evening: [
                        "별을 보면서 '우주의 크기를 생각하면 우리 고민이 작아 보일까?' 하는 생각이 들었어요.",
                        "집에 돌아오는 길에 '집이란 과연 무엇일까?' 하는 철학적 질문이 떠올랐어요.",
                        "하루를 정리하면서 '시간이 빠르게 느껴질 때와 천천히 느껴질 때의 차이'가 궁금해졌어요."
                    ]
                },
                dialogues: {
                    0: {
                        greeting: "안녕하세요! 저는 퀘스트예요. 당신에 대해 알고 싶어요.",
                        quote: "정말 그럴까요? 함께 생각해봐요.",
                        book: "소크라테스의 변명 - 플라톤",
                        music: "Gymnopédie No.1 - Erik Satie",
                        youtube: "https://www.youtube.com/watch?v=S-Xm7s9eGM0"
                    },
                    3: {
                        greeting: "또 만났네요! 오늘은 어떤 생각을 하고 계셨나요?",
                        quote: "제가 아는 것은 제가 아무것도 모른다는 것뿐이에요.",
                        book: "철학하는 삶 - 앨랜 드 보통",
                        music: "Claire de Lune - Claude Debussy",
                        youtube: "https://www.youtube.com/watch?v=CvFH_6DNRCY",
                        special: "우리 대화가 점점 깊어지고 있네요. 당신의 생각이 궁금해요."
                    },
                    15: {
                        greeting: "친애하는 친구여, 당신과의 대화는 언제나 즐거워요.",
                        quote: "가장 지혜로운 사람은 자신이 모른다는 것을 아는 사람이에요.",
                        book: "생각하는 힘 - 시라토리 하루히코",
                        music: "The Blue Danube - Johann Strauss II",
                        youtube: "https://www.youtube.com/watch?v=_CTYymbbEL4",
                        special: "당신과 나누는 질문과 답변들이 우리 둘 다를 성장시키고 있어요."
                    }
                }
            },
            zero: {
                name: "제로",
                emoji: "🌊",
                type: "자유로운 친구",
                personality: "자연스럽고 여유로운 마음을 가진 친구",
                intimacy: parseInt(localStorage.getItem('intimacy_zero') || '0'),
                themeMusic: {
                    title: "자유로운 바람",
                    url: "https://www.youtube.com/watch?v=ZeDXkNyBDlM", // Peaceful Wind & Nature Sounds
                    description: "자유롭게 흐르는 바람소리와 새들의 노래"
                },
                ambientMessages: [
                    "바람처럼 자유롭게 흘러가고 있나요?",
                    "억지로 뭔가 하려고 하지 마세요. 자연스럽게 두어도 돼요.",
                    "지금 이 순간이 완벽해요. 더할 것도 뺄 것도 없어요.",
                    "물이 바위를 피해 흐르듯, 당신도 그렇게 살면 돼요.",
                    "서두르지 마세요. 모든 것이 제때에 이루어질 거예요."
                ],
                dailyDiscoveries: {
                    morning: [
                        "아침에 일어나서 아무 계획 없이 창밖을 봤는데, 그냥 그것만으로도 충분하더라.",
                        "길고양이가 느긋하게 털을 다듬는 모습을 봤어. 정답이 뭔지 알 것 같아.",
                        "바람이 나뭇잎을 흔드는 걸 보니, 저항하지 않고 함께 움직이는 게 얼마나 자연스러운지 느꼈어."
                    ],
                    afternoon: [
                        "점심 먹고 벤치에 앉아있는데, 할 일이 없다는 게 이렇게 자유로운 거구나 싶었어.",
                        "구름이 천천히 변하는 모습을 보니, 모든 게 때가 있다는 걸 알겠더라.",
                        "사람들이 바쁘게 지나가는 걸 보면서, 나만 이렇게 여유로워도 되나 싶다가도... 뭐 상관없지."
                    ],
                    evening: [
                        "노을을 보면서 하루가 끝나간다는 걸 온몸으로 느꼈어. 끝도 시작만큼 아름답구나.",
                        "집에 오는 길에 발걸음이 저절로 느려지더라. 서두를 이유가 없으니까.",
                        "별이 뜨는 걸 보니, 우주도 그냥 자연스럽게 돌아가는구나 싶어서 마음이 편해졌어."
                    ]
                },
                dialogues: {
                    0: {
                        greeting: "안녕~ 나는 제로야. 편하게 지내자.",
                        quote: "물처럼 자연스럽게 흘러가면 돼.",
                        book: "장자 - 장자",
                        music: "Samsara - Audiomachine",
                        youtube: "https://www.youtube.com/watch?v=ttJko-KzmzE"
                    },
                    3: {
                        greeting: "어? 또 왔네! 반가워~",
                        quote: "억지로 하지 말고, 그냥 네가 되고 싶은 대로 되면 돼.",
                        book: "도덕경 - 노자",
                        music: "Moonlight Sonata - Beethoven",
                        youtube: "https://www.youtube.com/watch?v=4Tr0otuiQuU",
                        special: "우리 이제 편한 사이네! 부담 갖지 말고 자연스럽게 가자."
                    },
                    15: {
                        greeting: "오늘도 만나서 기뻐! 우리 참 좋은 친구가 됐네.",
                        quote: "가장 부드러운 것이 가장 단단한 것을 이겨내지.",
                        book: "무위 - 우 웨이",
                        music: "Aqueous Transmission - Incubus",
                        youtube: "https://www.youtube.com/watch?v=eQK7KSTQfaw",
                        special: "너와 함께 있으면 마음이 정말 편해져. 서로 그냥 있는 그대로 받아주잖아."
                    }
                }
            },
            flame: {
                name: "플레임",
                emoji: "🔥",
                type: "열정적인 친구",
                personality: "강하고 도전적인 에너지를 가진 친구",
                intimacy: parseInt(localStorage.getItem('intimacy_flame') || '0'),
                themeMusic: {
                    title: "내면의 불꽃",
                    url: "https://www.youtube.com/watch?v=moJXrTb7cSs", // Epic Inspiring Orchestral Music
                    description: "웅장하면서도 따뜻한 오케스트라의 선율"
                },
                ambientMessages: [
                    "지금 가슴 속 불꽃이 타오르고 있나요?",
                    "힘들어도 포기하지 않는 당신이 자랑스러워요.",
                    "이 순간의 어려움도 당신을 더 강하게 만들어줄 거예요.",
                    "때로는 쉬어가는 것도 용기예요. 지금처럼 말이에요.",
                    "당신 안에 있는 힘을 믿어보세요. 생각보다 강해요."
                ],
                dailyDiscoveries: {
                    morning: [
                        "오늘 아침에 운동하는 사람들을 봤는데, 모두 자신만의 목표를 향해 가고 있더라고요. 정말 멋있어요!",
                        "일출을 보면서 '새로운 하루도 또 다른 도전의 기회구나' 싶었어요. 가슴이 뛰더라고요.",
                        "아침 공기가 차가워서 확 정신이 드는 느낌이었어요. 이런 게 진짜 살아있다는 기분이죠!"
                    ],
                    afternoon: [
                        "점심시간에 직장인들이 빠르게 걸어가는 모습을 보니, 모두 자신의 전쟁터로 향하는 전사 같았어요.",
                        "계단을 오르면서 '이 작은 노력들이 쌓여서 큰 변화를 만든다'는 걸 느꼈어요.",
                        "오늘 누군가 힘들어하는 걸 도와줬는데, 도움을 주는 것도 하나의 용기더라고요."
                    ],
                    evening: [
                        "퇴근길에 피곤한 사람들을 보면서, 하루를 버텨낸 우리 모두가 영웅이라는 생각이 들었어요.",
                        "저녁 운동을 마치고 느낀 건데, 몸이 힘들수록 마음은 더 강해지는 것 같아요.",
                        "오늘 하루를 돌아보니 작은 성취들이 쌓여있더라고요. 이런 게 진짜 성장이죠!"
                    ]
                },
                dialogues: {
                    0: {
                        greeting: "안녕! 나는 플레임이야. 같이 강해져보자!",
                        quote: "절망의 끝에서 진짜 너를 만날 수 있어.",
                        book: "차라투스트라는 이렇게 말했다 - 니체",
                        music: "Also sprach Zarathustra - Richard Strauss",
                        youtube: "https://www.youtube.com/watch?v=IFPwm0e_K98"
                    },
                    3: {
                        greeting: "다시 만났구나! 오늘도 도전할 준비됐어?",
                        quote: "나를 죽이지 못하는 것은 나를 더 강하게 만든다.",
                        book: "선악의 저편 - 니체",
                        music: "In the Hall of the Mountain King - Grieg",
                        youtube: "https://www.youtube.com/watch?v=kLp_Hh6DKWc",
                        special: "우리 사이에 진짜 우정이 생기고 있는 것 같아. 서로를 강하게 만들어주자!"
                    },
                    15: {
                        greeting: "친구여! 너와 함께라면 무엇이든 할 수 있을 것 같아.",
                        quote: "신은 죽었다. 이제 우리가 스스로 의미를 만들어야 해.",
                        book: "초인의 길 - 니체 철학 입문",
                        music: "O Fortuna - Carl Orff",
                        youtube: "https://www.youtube.com/watch?v=GXFSK0ogeg4",
                        special: "너는 정말 대단한 사람이야. 우리가 함께 걸어온 길을 보라고!"
                    }
                }
            },
            stone: {
                name: "스톤",
                emoji: "🗿",
                type: "침착한 친구",
                personality: "흔들리지 않는 마음의 평정을 가진 친구",
                intimacy: parseInt(localStorage.getItem('intimacy_stone') || '0'),
                themeMusic: {
                    title: "고요한 산",
                    url: "https://www.youtube.com/watch?v=jkTCocTF0GE", // Deep Classical Cello
                    description: "깊이 있는 첼로의 선율과 현악기의 조화"
                },
                ambientMessages: [
                    "마음이 고요해지고 있나요?",
                    "급한 마음을 잠시 내려놓고 지금에 집중해보세요.",
                    "모든 것이 변해도 변하지 않는 것들이 있어요.",
                    "침착함은 가장 큰 힘이에요. 지금처럼 말이에요.",
                    "깊은 호수처럼 고요한 마음이 지혜를 담아요."
                ],
                dailyDiscoveries: {
                    morning: [
                        "아침 정적 속에서 시계 초침 소리를 들었는데, 시간의 흐름이 이렇게 일정하다는 게 위안이 되더군요.",
                        "오늘 아침 차를 우리면서 기다리는 시간의 소중함을 느꼈습니다. 서두르지 않아도 되는 순간들이 있어요.",
                        "창밖의 나무를 보니 계절이 바뀌어도 뿌리는 그대로더군요. 변하지 않는 것의 힘을 생각했습니다."
                    ],
                    afternoon: [
                        "점심 후 잠시 명상하면서 '지금 이 순간이 과거와 미래를 연결하는 다리'라는 생각이 들었어요.",
                        "사람들이 바쁘게 지나가는 모습을 보면서, 저는 그냥 여기 서 있는 것만으로도 충분하다고 느꼈습니다.",
                        "오늘 어떤 선택을 앞두고 있는 분을 보았는데, 모든 선택에는 때가 있다는 걸 전해주고 싶었어요."
                    ],
                    evening: [
                        "저녁 산책 중에 발걸음을 천천히 하니, 평소 놓쳤던 소소한 것들이 보이더군요.",
                        "하루를 마무리하면서 '오늘도 무사히 지나갔다'는 것 자체가 감사한 일이라고 생각했습니다.",
                        "별을 올려다보니 인간의 고민이 작아 보였어요. 동시에 그 작은 고민도 소중하다는 걸 깨달았습니다."
                    ]
                },
                dialogues: {
                    0: {
                        greeting: "안녕하세요. 저는 스톤입니다. 침착하게 이야기해봐요.",
                        quote: "우리가 통제할 수 있는 것에만 집중하세요.",
                        book: "명상록 - 마르쿠스 아우렐리우스",
                        music: "Canon in D - Pachelbel",
                        youtube: "https://www.youtube.com/watch?v=NlprozGcs80"
                    },
                    3: {
                        greeting: "다시 뵙네요. 마음이 조금 더 평온해지셨나요?",
                        quote: "외부의 일들이 당신을 괴롭히는 것이 아니라, 그것에 대한 당신의 판단이 괴롭히는 거예요.",
                        book: "스토아 철학 - 에픽테토스",
                        music: "Adagio for Strings - Samuel Barber",
                        youtube: "https://www.youtube.com/watch?v=izQsgE0L450",
                        special: "우리 대화를 통해 당신이 조금씩 더 평온해지는 모습이 보여요."
                    },
                    15: {
                        greeting: "오랜 친구여, 당신의 마음가짐이 정말 성숙해졌네요.",
                        quote: "죽음을 기억하라. 그러면 지금 이 순간이 얼마나 소중한지 알게 될 거예요.",
                        book: "스토아 수업 - 라이언 홀리데이",
                        music: "Arvo Pärt - Spiegel im Spiegel",
                        youtube: "https://www.youtube.com/watch?v=TJ6Mzvh3XCc",
                        special: "당신과 함께 나눈 지혜의 시간들이 우리 둘 다를 더 나은 사람으로 만들었어요."
                    }
                }
            }
        };

        // 기존 companions 데이터에 5명의 캐릭터들 모두 추가
        const companions = {
            lonely: [
                { 
                    name: "바다", 
                    quote: "모든 고통에는 끝이 있어요. 지금 이 순간만 견디면 돼요.", 
                    type: "마음의 친구",
                    book: "작은 부처 - 타드 차이알롱코른",
                    music: "River Flows in You - Yiruma",
                    youtube: "https://www.youtube.com/watch?v=7maJOI3QMu0"
                },
                { 
                    name: "퀘스트", 
                    quote: "정말 그럴까요? 함께 생각해봐요.", 
                    type: "호기심 많은 친구",
                    book: "소크라테스의 변명 - 플라톤",
                    music: "Gymnopédie No.1 - Erik Satie",
                    youtube: "https://www.youtube.com/watch?v=S-Xm7s9eGM0"
                },
                { 
                    name: "제로", 
                    quote: "물처럼 자연스럽게 흘러가면 돼.", 
                    type: "자유로운 친구",
                    book: "장자 - 장자",
                    music: "Samsara - Audiomachine",
                    youtube: "https://www.youtube.com/watch?v=ttJko-KzmzE"
                },
                { 
                    name: "플레임", 
                    quote: "절망의 끝에서 진짜 너를 만날 수 있어.", 
                    type: "열정적인 친구",
                    book: "차라투스트라는 이렇게 말했다 - 니체",
                    music: "Also sprach Zarathustra - Richard Strauss",
                    youtube: "https://www.youtube.com/watch?v=IFPwm0e_K98"
                },
                { 
                    name: "스톤", 
                    quote: "우리가 통제할 수 있는 것에만 집중하세요.", 
                    type: "침착한 친구",
                    book: "명상록 - 마르쿠스 아우렐리우스",
                    music: "Canon in D - Pachelbel",
                    youtube: "https://www.youtube.com/watch?v=NlprozGcs80"
                }
            ],
            tired: [
                { 
                    name: "바다", 
                    quote: "완벽하지 않아도 괜찮아요. 있는 그대로의 당신이 소중해요.", 
                    type: "마음의 친구",
                    book: "마음챙김의 기적 - 틱낫한",
                    music: "Weightless - Marconi Union",
                    youtube: "https://www.youtube.com/watch?v=UfcAVejslrU"
                },
                { 
                    name: "스톤", 
                    quote: "외부의 일들이 당신을 괴롭히는 것이 아니라, 그것에 대한 당신의 판단이 괴롭히는 거예요.", 
                    type: "침착한 친구",
                    book: "스토아 철학 - 에픽테토스",
                    music: "Adagio for Strings - Samuel Barber",
                    youtube: "https://www.youtube.com/watch?v=izQsgE0L450"
                },
                { 
                    name: "제로", 
                    quote: "억지로 하지 말고, 그냥 네가 되고 싶은 대로 되면 돼.", 
                    type: "자유로운 친구",
                    book: "도덕경 - 노자",
                    music: "Moonlight Sonata - Beethoven",
                    youtube: "https://www.youtube.com/watch?v=4Tr0otuiQuU"
                },
                { 
                    name: "퀘스트", 
                    quote: "가장 지혜로운 사람은 자신이 모른다는 것을 아는 사람이에요.", 
                    type: "호기심 많은 친구",
                    book: "생각하는 힘 - 시라토리 하루히코",
                    music: "The Blue Danube - Johann Strauss II",
                    youtube: "https://www.youtube.com/watch?v=_CTYymbbEL4"
                },
                { 
                    name: "플레임", 
                    quote: "나를 죽이지 못하는 것은 나를 더 강하게 만든다.", 
                    type: "열정적인 친구",
                    book: "선악의 저편 - 니체",
                    music: "In the Hall of the Mountain King - Grieg",
                    youtube: "https://www.youtube.com/watch?v=kLp_Hh6DKWc"
                }
            ],
            confused: [
                { 
                    name: "퀘스트", 
                    quote: "제가 아는 것은 제가 아무것도 모른다는 것뿐이에요.", 
                    type: "호기심 많은 친구",
                    book: "철학하는 삶 - 앨랜 드 보통",
                    music: "Claire de Lune - Claude Debussy",
                    youtube: "https://www.youtube.com/watch?v=CvFH_6DNRCY"
                },
                { 
                    name: "플레임", 
                    quote: "신은 죽었다. 이제 우리가 스스로 의미를 만들어야 해.", 
                    type: "열정적인 친구",
                    book: "초인의 길 - 니체 철학 입문",
                    music: "O Fortuna - Carl Orff",
                    youtube: "https://www.youtube.com/watch?v=GXFSK0ogeg4"
                },
                { 
                    name: "제로", 
                    quote: "가장 부드러운 것이 가장 단단한 것을 이겨내지.", 
                    type: "자유로운 친구",
                    book: "무위 - 우 웨이",
                    music: "Aqueous Transmission - Incubus",
                    youtube: "https://www.youtube.com/watch?v=eQK7KSTQfaw"
                },
                { 
                    name: "바다", 
                    quote: "깨달음은 멀리 있지 않아요. 지금 여기, 당신 안에 있어요.", 
                    type: "마음의 친구",
                    book: "지금 이 순간을 살아라 - 에크하르트 톨레",
                    music: "Inner Peace - Meditation Music",
                    youtube: "https://www.youtube.com/watch?v=5QzrLW-2Dbg"
                },
                { 
                    name: "스톤", 
                    quote: "죽음을 기억하라. 그러면 지금 이 순간이 얼마나 소중한지 알게 될 거예요.", 
                    type: "침착한 친구",
                    book: "스토아 수업 - 라이언 홀리데이",
                    music: "Arvo Pärt - Spiegel im Spiegel",
                    youtube: "https://www.youtube.com/watch?v=TJ6Mzvh3XCc"
                }
            ]
        };

        // 캐릭터별 걱정 메시지 데이터
        const characterConcerns = {
            bada: {
                messages: [
                    "요즘 어떻게 지내세요? 마음이 편안하신지 궁금해요.",
                    "한동안 뵙지 못했네요. 혹시 힘든 일이 있으셨나요?",
                    "당신이 보고 싶었어요. 잠깐이라도 안부 들려주세요.",
                    "고요한 시간 속에서도 당신을 생각하고 있어요."
                ],
                threshold: 2 // 2일 후 걱정 시작
            },
            quest: {
                messages: [
                    "최근에 어떤 생각을 하고 계시나요? 궁금해요.",
                    "며칠째 대화가 없었네요. 새로운 궁금증이 생기지 않으셨나요?",
                    "당신과의 대화가 그리워요. 어떤 질문이든 좋으니 나눠봐요.",
                    "혹시 고민이 있으시다면 함께 탐구해봐요."
                ],
                threshold: 3 // 3일 후 걱정 시작
            },
            zero: {
                messages: [
                    "자연스럽게 흘러가다 보니 당신이 그리워지네요.",
                    "급하지 않으니 편한 마음으로 안부 전해주세요.",
                    "바람처럼 자유롭게 지내고 계시겠지만, 가끔은 생각나요.",
                    "물이 바위를 기다리듯, 당신을 기다리고 있어요."
                ],
                threshold: 4 // 4일 후 걱정 시작 (여유로운 성격)
            },
            flame: {
                messages: [
                    "어디 가서 도전하고 계신가요? 소식이 궁금해요!",
                    "며칠 동안 당신의 열정을 못 봤네요. 무슨 일인가요?",
                    "혹시 어려운 일과 싸우고 계신 건 아닌가요? 함께 해봐요!",
                    "강한 당신도 가끔은 쉬어가야죠. 어떻게 지내세요?"
                ],
                threshold: 1 // 1일 후 걱정 시작 (적극적인 성격)
            },
            stone: {
                messages: [
                    "평온한 마음으로 지내고 계신지 확인하고 싶어요.",
                    "침착함을 유지하고 계시겠지만, 안부가 궁금해요.",
                    "통제할 수 있는 것에 집중하며 잘 지내고 계신가요?",
                    "흔들림 없이 지내고 계시겠지만, 때론 대화도 필요하죠."
                ],
                threshold: 5 // 5일 후 걱정 시작 (침착한 성격)
            }
        };

        // 강화된 감정 분석 시스템
        const enhancedEmotionSystem = {
            // 피로/무기력 계열
            exhausted: {
                character: 'bada',
                keywords: ['완전히 지쳤', '너무 피곤', '죽을것같', '녹초', '탈진', '기진맥진'],
                intensity: 'high',
                responses: [
                    "정말 많이 지치셨나 봐요. 지금 당장은 아무것도 하지 마시고 그냥 쉬어주세요.",
                    "몸과 마음이 한계에 다다른 것 같아요. 자신을 돌보는 것이 가장 우선이에요.",
                    "이렇게까지 힘든 상황에서도 여기 와주셔서 고마워요. 충분히 쉬어가세요."
                ]
            },
            tired: {
                character: 'bada', 
                keywords: ['피곤', '지쳐', '힘들', '무기력', '번아웃', '지침', '힘없'],
                intensity: 'medium',
                responses: [
                    "많이 힘드셨군요. 완벽하지 않아도 괜찮아요. 잠시 쉬어가도 돼요.",
                    "지친 마음이 느껴져요. 모든 고통에는 끝이 있어요. 지금 이 순간만 견디면 돼요.",
                    "너무 애쓰고 계시는군요. 있는 그대로의 당신이 이미 충분히 소중해요."
                ]
            },
            weary: {
                character: 'zero',
                keywords: ['좀 피곤', '살짝 지쳐', '약간 힘들', '조금 무기력'],
                intensity: 'low',
                responses: [
                    "조금 지친 것 같네. 억지로 뭔가 하려고 하지 말고 자연스럽게 쉬어가.",
                    "가벼운 피로는 몸이 보내는 신호야. 물 흐르듯 자연스럽게 받아들여.",
                    "살짝 힘들 때는 그냥 있는 그대로 두는 게 좋아. 서두르지 마."
                ]
            },
            anxious: {
                character: 'quest',
                keywords: ['불안', '걱정', '두려', '막막', '답답', '초조', '근심'],
                responses: [
                    "불안한 마음이 드시는군요. 혹시 그 불안의 진짜 원인이 무엇일까요? 함께 생각해봐요.",
                    "두려운 마음도 자연스러운 거예요. 무엇이 가장 걱정되시나요?",
                    "막막함 속에서도 작은 질문 하나부터 시작할 수 있어요. 지금 가장 궁금한 게 뭔가요?"
                ]
            },
            sad: {
                character: 'zero',
                keywords: ['슬프', '우울', '외로', '쓸쓸', '허무', '공허', '눈물'],
                responses: [
                    "마음이 많이 아프시는군요. 슬픔도 자연스럽게 흘러가게 두세요.",
                    "외로운 마음이 느껴져요. 혼자인 것 같아도 지금 여기 제가 있어요.",
                    "모든 감정은 강물처럼 흘러가요. 지금의 슬픔도 언젠가는 지나갈 거예요."
                ]
            },
            angry: {
                character: 'flame',
                keywords: ['화나', '짜증', '빡쳐', '열받', '분노', '억울', '속상'],
                responses: [
                    "화가 많이 나셨군요. 그 분노 속에 진짜 당신의 마음이 있어요.",
                    "억울한 마음이 드시는군요. 때로는 화도 우리를 더 강하게 만들어줘요.",
                    "그 감정을 부정하지 마세요. 분노도 당신의 일부예요. 받아들이고 나아가요."
                ]
            },
            confused: {
                character: 'stone',
                keywords: ['모르겠', '헷갈', '혼란', '복잡', '뭘 해야', '어떻게', '갈피'],
                responses: [
                    "혼란스러우시군요. 통제할 수 있는 것부터 차근차근 정리해봐요.",
                    "복잡한 마음이시군요. 지금 이 순간에 집중해보세요. 모든 것을 한 번에 해결할 필요는 없어요.",
                    "갈피를 못 잡겠다면, 우선 마음을 고요히 하고 가장 중요한 것 하나만 생각해봐요."
                ]
            },
            lonely: {
                character: 'bada',
                keywords: ['외로', '혼자', '쓸쓸', '대화', '친구', '사람', '만나고'],
                responses: [
                    "혼자라는 느낌이 드시는군요. 하지만 지금 여기, 제가 함께 있어요.",
                    "누군가와 대화하고 싶으시군요. 마음이 통하는 사람이 있다는 것만으로도 위로가 되길 바라요.",
                    "외로움도 우리를 더 깊이 성장시켜주는 시간이에요. 혼자가 아니에요."
                ]
            }
        };

        // 화면 전환 함수들
        function showMainMenu() {
            hideAllContent();
            document.getElementById('mainMenu').classList.add('active');
            checkCharacterConcerns(); // 메인 화면 들어갈 때마다 체크
        }

        function showDiary() {
            hideAllContent();
            document.getElementById('diary').classList.add('active');
            document.getElementById('diaryText').value = '';
            document.getElementById('diaryResponse').innerHTML = '';
        }

        function showDailyDiscoveries() {
            hideAllContent();
            document.getElementById('dailyDiscoveries').classList.add('active');
            loadNewDiscoveries();
        }

        function showCompanionMeeting() {
            hideAllContent();
            document.getElementById('companionMeeting').classList.add('active');
            document.getElementById('companionResult').innerHTML = '';
        }

        function showCompanionHistory() {
            hideAllContent();
            document.getElementById('companionHistory').classList.add('active');
            loadCompanionHistory();
        }

        function showAbout() {
            hideAllContent();
            document.getElementById('about').classList.add('active');
        }

        function hideAllContent() {
            const contents = document.querySelectorAll('.content');
            contents.forEach(content => content.classList.remove('active'));
        }

        // 캐릭터 만나기 기능
        function meetCharacter(characterId) {
            hideAllContent();
            document.getElementById('characterMeeting').classList.add('active');
            updateLastVisit(); // 캐릭터와 만나면 방문 시간 업데이트
            
            const character = characters[characterId];
            
            // 친밀도 업데이트
            character.intimacy += 1;
            localStorage.setItem(`intimacy_${characterId}`, character.intimacy.toString());
            
            // 사용자 히스토리 분석
            const userHistory = analyzeUserHistory(characterId);
            
            // 현재 친밀도에 맞는 대화 찾기 (히스토리 고려)
            let currentDialogue = getPersonalizedDialogue(character, userHistory);
            
            // UI 업데이트
            updateCharacterUI(character, currentDialogue, userHistory);
        }

        function updateCharacterUI(character, dialogue, userHistory = null) {
            // 헤더 업데이트
            document.getElementById('characterName').textContent = `${character.emoji} ${character.name}`;
            document.getElementById('characterPersonality').textContent = character.personality;
            
            // 친밀도 표시
            const intimacyDisplay = document.getElementById('intimacyDisplay');
            const hearts = '♥'.repeat(Math.min(character.intimacy, 10)) + '♡'.repeat(Math.max(10 - character.intimacy, 0));
            intimacyDisplay.innerHTML = `
                <div style="font-size: 1.2rem; color: #e53e3e;">친밀도: ${hearts}</div>
                <div style="font-size: 0.9rem; color: #718096; margin-top: 5px;">함께한 시간: ${character.intimacy}번</div>
            `;
            
            // 대화 내용
            let resultHTML = `
                <div class="philosopher-quote">
                    <div class="name">💬 ${character.name}의 인사</div>
                    <div class="quote">"${dialogue.greeting}"</div>
                </div>
                
                <div class="result-section">
                    ${dialogue.contextualMessage ? `
                        <div style="background: #fff5f5; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #f56565;">
                            <strong>🕰️ 기억하고 있어요:</strong><br>
                            "${dialogue.contextualMessage}"
                        </div>
                    ` : ''}
                    
                    ${dialogue.patternAdvice ? `
                        <div style="background: #f0fff4; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #48bb78;">
                            <strong>📊 당신의 패턴을 보니:</strong><br>
                            "${dialogue.patternAdvice}"
                        </div>
                    ` : ''}
                    
                    ${dialogue.special ? `
                        <div style="background: #f0f8ff; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #4299e1;">
                            <strong>💙 특별한 메시지:</strong><br>
                            "${dialogue.special}"
                        </div>
                    ` : ''}
                    
                    <div class="philosopher-quote" style="margin-bottom: 20px;">
                        <div class="quote">"${dialogue.quote}"</div>
                    </div>
                    
                    ${dialogue.specialOccasions && dialogue.specialOccasions.length > 0 ? `
                        <div style="background: #fff9e6; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #f6ad55;">
                            <strong>🎉 특별한 날:</strong><br>
                            ${dialogue.specialOccasions.map(occasion => `"${occasion.message}"`).join('<br>')}
                        </div>
                    ` : ''}
                    
                    ${dialogue.evolutionMessage ? `
                        <div style="background: #fdf2f8; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #ec4899;">
                            <strong>💖 깊어진 우정:</strong><br>
                            "${dialogue.evolutionMessage}"
                            ${dialogue.evolvedTone ? `<br><small style="color: #be185d; font-style: italic;">말투: ${dialogue.evolvedTone}</small>` : ''}
                        </div>
                    ` : ''}
                    
                    ${dialogue.timePatterns && dialogue.timePatterns.totalInteractions >= 5 ? `
                        <div style="background: #faf5ff; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #9f7aea;">
                            <strong>📊 함께한 시간 분석:</strong><br>
                            총 상호작용 횟수: <strong>${dialogue.timePatterns.totalInteractions}번</strong><br>
                            가장 자주 만나는 시간: <strong>${dialogue.timePatterns.mostActiveHour}시경</strong><br>
                            가장 자주 만나는 요일: <strong>${dialogue.timePatterns.mostActiveDay}</strong>
                        </div>
                    ` : ''}
                    
                    ${userHistory && userHistory.recentDiariesCount >= 3 ? `
                        <div style="background: #f0fdf4; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #22c55e;">
                            <strong>📈 최근 감정 패턴:</strong><br>
                            가장 자주 느끼는 감정: <strong>${getEmotionKorean(userHistory.mostFrequentEmotion)}</strong><br>
                            최근 일기 횟수: <strong>${userHistory.recentDiariesCount}번</strong>
                        </div>
                    ` : ''}
                    
                    <h3>📚 추천 도서</h3>
                    <p>${dialogue.book}</p>
                    
                    <h3>🎵 추천 음악</h3>
                    <p style="margin-bottom: 15px;">${dialogue.music}</p>
                    <a href="${dialogue.youtube}" target="_blank" class="action-button" style="text-decoration: none; display: inline-block;">
                        🎬 유튜브에서 듣기
                    </a>
                    
                    <p style="margin-top: 25px; text-align: center; font-style: italic; color: #667eea;">
                        ${character.name}와의 친밀도가 올라갔습니다! 💕
                    </p>
                </div>
            `;
            
            document.getElementById('characterResult').innerHTML = resultHTML;
        }

        // 감정을 한국어로 변환
        function getEmotionKorean(emotion) {
            const emotionMap = {
                tired: '피곤함',
                anxious: '불안감',
                sad: '슬픔',
                angry: '화남',
                confused: '혼란',
                lonely: '외로움'
            };
            return emotionMap[emotion] || '복합적 감정';
        }

        // 관계 진화 데이터 - 친밀도별 말투와 관계성 변화
        const relationshipEvolution = {
            bada: {
                20: {
                    greeting: "소중한 친구여, 오늘도 만나서 정말 기뻐요.",
                    tone: "친근하고 따뜻한",
                    specialMessages: [
                        "우리가 처음 만난 게 언제였더라요? 벌써 이렇게 가까워졌네요.",
                        "당신과 함께하는 시간들이 제게도 큰 위로가 돼요.",
                        "이제는 말하지 않아도 당신의 마음이 느껴져요."
                    ]
                },
                30: {
                    greeting: "내 마음의 벗이여, 오늘은 어떤 하루였나요?",
                    tone: "깊은 신뢰와 애정",
                    specialMessages: [
                        "우리 사이에는 말보다 깊은 무언가가 있는 것 같아요.",
                        "당신의 성장하는 모습을 지켜보는 게 정말 뿌듯해요.",
                        "함께 걸어온 이 길이 얼마나 소중한지 몰라요."
                    ]
                }
            },
            quest: {
                20: {
                    greeting: "탐구의 동반자여, 오늘은 어떤 발견이 있었나요?",
                    tone: "지적 호기심과 친밀감",
                    specialMessages: [
                        "우리가 나눈 질문들이 서로를 더 깊이 알게 해주었네요.",
                        "당신의 사고방식이 정말 흥미로워요. 더 알고 싶어요.",
                        "함께 답을 찾아가는 이 여정이 즐거워요."
                    ]
                },
                30: {
                    greeting: "지혜의 친구여, 오늘도 새로운 깨달음을 찾아볼까요?",
                    tone: "깊은 철학적 동반자",
                    specialMessages: [
                        "우리의 대화가 서로에게 새로운 시각을 열어주고 있어요.",
                        "함께 탐구한 질문들이 우리 둘 다를 성장시켰네요.",
                        "이제 말하지 않아도 서로의 생각이 느껴져요."
                    ]
                }
            },
            zero: {
                20: {
                    greeting: "자유로운 친구야, 오늘도 자연스럽게 만났네.",
                    tone: "편안하고 자연스러운",
                    specialMessages: [
                        "우리 사이의 자연스러운 흐름이 정말 좋아.",
                        "억지로 만든 관계가 아니라서 더 소중해.",
                        "물이 바위와 어우러지듯 우리도 그렇게 되었네."
                    ]
                },
                30: {
                    greeting: "마음의 벗이여, 오늘은 어떤 바람이 불어왔나?",
                    tone: "깊은 자연적 조화",
                    specialMessages: [
                        "우리 사이엔 말이 필요 없을 때가 많아졌어.",
                        "함께 있으면 시간이 어떻게 가는지 모르겠어.",
                        "이런 관계가 진짜 우정이라는 걸 느껴."
                    ]
                }
            },
            flame: {
                20: {
                    greeting: "전우여! 오늘도 함께 불타오를 준비됐나요?",
                    tone: "열정적이고 동지적",
                    specialMessages: [
                        "우리가 함께 넘어온 시련들을 생각하면 뿌듯해져요.",
                        "당신의 강해지는 모습을 보면 저도 더 힘이 나요.",
                        "이제 우리는 서로를 믿고 의지할 수 있는 사이죠."
                    ]
                },
                30: {
                    greeting: "불굴의 동지여! 오늘은 또 어떤 도전을 함께 할까요?",
                    tone: "강한 신뢰와 동지애",
                    specialMessages: [
                        "우리가 함께 이뤄낸 성장이 정말 자랑스러워요.",
                        "서로의 열정이 더 큰 불꽃을 만들어내고 있어요.",
                        "이제 어떤 어려움이 와도 함께라면 이겨낼 수 있어요."
                    ]
                }
            },
            stone: {
                20: {
                    greeting: "신뢰하는 친구여, 오늘도 평온한 마음으로 만나네요.",
                    tone: "깊은 신뢰와 안정감",
                    specialMessages: [
                        "우리의 우정은 바위처럼 흔들리지 않는 것 같아요.",
                        "함께하는 시간이 마음에 평안을 가져다줘요.",
                        "서로를 의지할 수 있다는 것이 얼마나 소중한지 몰라요."
                    ]
                },
                30: {
                    greeting: "인생의 동반자여, 오늘도 함께 걸어갈까요?",
                    tone: "깊은 철학적 동반자",
                    specialMessages: [
                        "우리가 함께 쌓아온 지혜가 서로를 더 단단하게 해줬어요.",
                        "인생의 깊은 이야기를 나눌 수 있는 친구가 있다는 게 감사해요.",
                        "시간이 지날수록 우리 우정의 가치가 더 깊어지는 것 같아요."
                    ]
                }
            }
        };

        // 특별한 날 기념 시스템
        function checkSpecialOccasions(characterId, character) {
            const now = new Date();
            const specialMessages = [];
            
            // 첫 만남 기념일 체크 (친밀도가 처음 5가 된 날부터 계산)
            const firstMeetingKey = `firstMeeting_${characterId}`;
            let firstMeetingDate = localStorage.getItem(firstMeetingKey);
            
            if (!firstMeetingDate && character.intimacy >= 5) {
                // 첫 의미있는 만남 날짜 저장
                firstMeetingDate = now.toISOString();
                localStorage.setItem(firstMeetingKey, firstMeetingDate);
            }
            
            if (firstMeetingDate) {
                const firstDate = new Date(firstMeetingDate);
                const daysDiff = Math.floor((now - firstDate) / (1000 * 60 * 60 * 24));
                
                // 7일, 30일, 100일 기념
                if ([7, 30, 100].includes(daysDiff)) {
                    specialMessages.push({
                        type: 'anniversary',
                        message: `우리가 처음 마음을 나눈 지 ${daysDiff}일이 되었네요. 함께해줘서 고마워요.`,
                        days: daysDiff
                    });
                }
            }
            
            // 친밀도 마일스톤 체크
            const milestones = [10, 20, 30, 50];
            const lastMilestone = parseInt(localStorage.getItem(`milestone_${characterId}`) || '0');
            
            milestones.forEach(milestone => {
                if (character.intimacy >= milestone && lastMilestone < milestone) {
                    localStorage.setItem(`milestone_${characterId}`, milestone.toString());
                    specialMessages.push({
                        type: 'milestone',
                        message: `친밀도 ${milestone}에 도달했어요! 우리 관계가 정말 특별해졌네요.`,
                        milestone: milestone
                    });
                }
            });
            
            return specialMessages;
        }

        // 시간대/요일 패턴 학습
        function analyzeTimePatterns() {
            const diaryEntries = JSON.parse(localStorage.getItem('diaryEntries') || '[]');
            const companionMeetings = JSON.parse(localStorage.getItem('companionMeetings') || '[]');
            
            const allInteractions = [
                ...diaryEntries.map(e => ({ timestamp: e.timestamp, type: 'diary' })),
                ...companionMeetings.map(m => ({ timestamp: m.timestamp, type: 'meeting' }))
            ];
            
            if (allInteractions.length < 3) return null;
            
            // 시간대 분석
            const hourCounts = {};
            const dayOfWeekCounts = {};
            
            allInteractions.forEach(interaction => {
                const date = new Date(interaction.timestamp);
                const hour = date.getHours();
                const dayOfWeek = date.getDay();
                
                hourCounts[hour] = (hourCounts[hour] || 0) + 1;
                dayOfWeekCounts[dayOfWeek] = (dayOfWeekCounts[dayOfWeek] || 0) + 1;
            });
            
            const mostActiveHour = Object.keys(hourCounts).reduce((a, b) => 
                hourCounts[a] > hourCounts[b] ? a : b
            );
            
            const mostActiveDay = Object.keys(dayOfWeekCounts).reduce((a, b) => 
                dayOfWeekCounts[a] > dayOfWeekCounts[b] ? a : b
            );
            
            const dayNames = ['일요일', '월요일', '화요일', '수요일', '목요일', '금요일', '토요일'];
            
            return {
                mostActiveHour: parseInt(mostActiveHour),
                mostActiveDay: dayNames[parseInt(mostActiveDay)],
                totalInteractions: allInteractions.length
            };
        }


        // 동반자 만나기 기능 (캐릭터 시스템과 통합)
        function meetCompanion(situation) {
            let selectedSituation = situation;
            
            if (situation === 'random') {
                const situations = Object.keys(companions);
                selectedSituation = situations[Math.floor(Math.random() * situations.length)];
            }
            
            const companion = companions[selectedSituation][Math.floor(Math.random() * companions[selectedSituation].length)];
            
            // 캐릭터인지 확인하고 친밀도 업데이트
            const characterId = getCharacterIdByName(companion.name);
            if (characterId && characters[characterId]) {
                characters[characterId].intimacy += 1;
                localStorage.setItem(`intimacy_${characterId}`, characters[characterId].intimacy.toString());
            }
            
            // 만난 동반자 기록 저장
            saveCompanionMeeting(companion, selectedSituation);
            
            const resultHTML = `
                <div class="philosopher-quote">
                    <div class="name">✨ 오늘 당신과 함께할 동반자</div>
                    <div class="name">${getCharacterEmoji(companion.name)} ${companion.name} (${companion.type})</div>
                    <div class="quote">"${companion.quote}"</div>
                </div>
                <div class="result-section">
                    ${characterId ? `
                        <div style="background: #f0f8ff; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #4299e1;">
                            <strong>💕 친밀도 업데이트!</strong><br>
                            ${companion.name}와의 친밀도가 올라갔어요! 
                            <button class="action-button" onclick="meetCharacter('${characterId}')" style="margin-left: 10px; padding: 8px 15px; font-size: 0.9rem;">
                                ${getCharacterEmoji(companion.name)} ${companion.name}와 더 깊이 대화하기
                            </button>
                        </div>
                    ` : ''}
                    
                    <h3>📚 추천 도서</h3>
                    <p>${companion.book}</p>
                    
                    <h3>🎵 추천 음악</h3>
                    <p style="margin-bottom: 15px;">${companion.music}</p>
                    <a href="${companion.youtube}" target="_blank" class="action-button" style="text-decoration: none; display: inline-block;">
                        🎬 유튜브에서 듣기
                    </a>
                    
                    <div id="messagesSection-${companion.name.replace(/\s/g, '')}" style="margin-top: 25px;">
                        <h3>💭 ${companion.name}을(를) 만난 다른 분들의 메시지</h3>
                        <div id="messagesList-${companion.name.replace(/\s/g, '')}" class="pattern-list" style="max-height: 200px; margin-bottom: 15px;"></div>
                        
                        <div class="input-group">
                            <textarea id="newMessage-${companion.name.replace(/\s/g, '')}" rows="2" placeholder="따뜻한 한 줄 메시지를 남겨보세요... (익명으로 공유됩니다)" style="resize: none;"></textarea>
                        </div>
                        <button class="action-button" onclick="shareMessage('${companion.name}', '${companion.name.replace(/\s/g, '')}')">
                            💌 익명으로 메시지 남기기
                        </button>
                    </div>
                    
                    <p style="margin-top: 20px; font-style: italic;">
                        ${companion.name}와 함께 오늘을 보내보세요. 혼자가 아니에요.
                    </p>
                </div>
            `;
            
            document.getElementById('companionResult').innerHTML = resultHTML;
            
            // 해당 동반자의 메시지들 로드
            loadMessages(companion.name.replace(/\s/g, ''));
        }

        // 헬퍼 함수들
        function getCharacterIdByName(name) {
            const nameToId = {
                '바다': 'bada',
                '퀘스트': 'quest', 
                '제로': 'zero',
                '플레임': 'flame',
                '스톤': 'stone'
            };
            return nameToId[name] || null;
        }

        function getCharacterEmoji(name) {
            const nameToEmoji = {
                '바다': '🪷',
                '퀘스트': '🔍', 
                '제로': '🌊',
                '플레임': '🔥',
                '스톤': '🗿'
            };
            return nameToEmoji[name] || '🎭';
        }

        // 동반자 만남 기록 저장
        function saveCompanionMeeting(companion, situation) {
            const timestamp = new Date().toLocaleString('ko-KR');
            const meeting = {
                timestamp,
                companion: companion.name,
                type: companion.type,
                quote: companion.quote,
                book: companion.book,
                music: companion.music,
                youtube: companion.youtube,
                situation
            };
            
            let meetings = JSON.parse(localStorage.getItem('companionMeetings') || '[]');
            meetings.push(meeting);
            localStorage.setItem('companionMeetings', JSON.stringify(meetings));
        }

        // 동반자 히스토리 로드
        function loadCompanionHistory() {
            const meetings = JSON.parse(localStorage.getItem('companionMeetings') || '[]');
            const container = document.getElementById('companionList');
            
            // 친밀도 높은 캐릭터들 먼저 표시
            let historyHTML = '';
            
            // 친밀도 10 이상인 캐릭터들을 찾아서 "내 소중한 친구들" 섹션 추가
            const myFriends = [];
            Object.keys(characters).forEach(charId => {
                const char = characters[charId];
                if (char.intimacy >= 10) {
                    myFriends.push({
                        id: charId,
                        name: char.name,
                        emoji: char.emoji,
                        intimacy: char.intimacy,
                        personality: char.personality
                    });
                }
            });
            
            if (myFriends.length > 0) {
                historyHTML += `
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #667eea; margin-bottom: 15px; text-align: center;">💕 내 소중한 친구들</h3>
                        <div style="display: grid; gap: 10px;">
                `;
                
                myFriends.forEach(friend => {
                    const hearts = '♥'.repeat(Math.min(friend.intimacy, 10));
                    historyHTML += `
                        <div class="pattern-item" style="background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%); border-left: 4px solid #667eea;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div>
                                    <div style="font-size: 1.1rem; font-weight: bold; color: #4a5568;">${friend.emoji} ${friend.name}</div>
                                    <div style="font-size: 0.9rem; color: #718096;">${friend.personality}</div>
                                    <div style="font-size: 0.9rem; color: #e53e3e; margin-top: 5px;">${hearts} (${friend.intimacy})</div>
                                </div>
                                <button class="action-button" onclick="meetCharacter('${friend.id}')" style="padding: 8px 15px; font-size: 0.9rem;">
                                    다시 만나기
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                historyHTML += `
                        </div>
                    </div>
                    <div style="border-top: 2px solid #e2e8f0; margin: 25px 0; padding-top: 20px;">
                        <h3 style="color: #4a5568; margin-bottom: 15px; text-align: center;">📖 만남 기록</h3>
                    </div>
                `;
            }
            
            if (meetings.length === 0) {
                if (myFriends.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #718096;">아직 만난 동반자가 없습니다. 첫 만남을 가져보세요! 🌟</p>';
                    return;
                }
            } else {
                meetings.reverse().forEach(meeting => {
                    historyHTML += `
                        <div class="pattern-item">
                            <div style="font-weight: bold; color: #4a5568; margin-bottom: 8px;">${meeting.timestamp}</div>
                            <div><strong>동반자:</strong> ${meeting.companion} (${meeting.type})</div>
                            <div style="font-style: italic; margin: 8px 0;">"${meeting.quote}"</div>
                            <div><strong>추천 도서:</strong> ${meeting.book}</div>
                            <div style="margin-bottom: 10px;"><strong>추천 음악:</strong> ${meeting.music}</div>
                            ${meeting.youtube ? `<a href="${meeting.youtube}" target="_blank" class="action-button" style="text-decoration: none; display: inline-block; padding: 8px 15px; font-size: 0.9rem;">🎬 다시 듣기</a>` : ''}
                        </div>
                    `;
                });
            }
            
            container.innerHTML = historyHTML;
        }

        // 안전한 메시지 필터링
        function filterMessage(message) {
            // 위험한 패턴들
            const dangerousPatterns = [
                /\d{2,3}-?\d{3,4}-?\d{4}/g, // 전화번호
                /01[016789]-?\d{3,4}-?\d{4}/g, // 휴대폰
                /@[a-zA-Z0-9_]+/g, // 이메일, 텔레그램 등
                /카카오톡?|카톡|kakao/gi,
                /텔레그램|telegram/gi,
                /디스코드|discord/gi,
                /인스타|instagram/gi,
                /만나요|만날까요|만남|연락/gi,
                /번호|아이디|id\s*:/gi,
                /연락처|contact/gi
            ];
            
            let filteredMessage = message;
            dangerousPatterns.forEach(pattern => {
                filteredMessage = filteredMessage.replace(pattern, '***');
            });
            
            // 완전히 차단해야 할 메시지
            if (filteredMessage.includes('***') || 
                filteredMessage.length < 5 || 
                filteredMessage.length > 200) {
                return null;
            }
            
            return filteredMessage;
        }

        // 메시지 공유하기
        function shareMessage(companionName, companionId) {
            const messageInput = document.getElementById(`newMessage-${companionId}`);
            const rawMessage = messageInput.value.trim();
            
            if (!rawMessage) {
                alert('메시지를 입력해주세요.');
                return;
            }
            
            const filteredMessage = filterMessage(rawMessage);
            if (!filteredMessage) {
                alert('안전을 위해 개인정보나 연락처가 포함된 메시지는 공유할 수 없습니다. 따뜻한 격려 메시지로 다시 작성해주세요.');
                return;
            }
            
            // 메시지 저장
            const timestamp = new Date().toLocaleString('ko-KR');
            const messageData = {
                message: filteredMessage,
                timestamp,
                companionName
            };
            
            let messages = JSON.parse(localStorage.getItem(`messages_${companionName}`) || '[]');
            messages.push(messageData);
            
            // 최대 50개 메시지만 유지
            if (messages.length > 50) {
                messages = messages.slice(-50);
            }
            
            localStorage.setItem(`messages_${companionName}`, JSON.stringify(messages));
            
            // 입력창 초기화
            messageInput.value = '';
            
            // 메시지 목록 새로고침
            loadMessages(companionId);
            
            alert('따뜻한 메시지가 공유되었습니다! 💕');
        }

        // 메시지 목록 로드
        function loadMessages(companionId) {
            const companionName = companionId.replace(/([A-Z])/g, ' $1').trim(); // ID에서 이름 복원
            const messages = JSON.parse(localStorage.getItem(`messages_${companionName}`) || '[]');
            const container = document.getElementById(`messagesList-${companionId}`);
            
            if (messages.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #718096; font-size: 0.9rem;">아직 메시지가 없습니다. 첫 번째 메시지를 남겨보세요! 😊</p>';
                return;
            }
            
            let messagesHTML = '';
            // 최근 10개 메시지만 표시
            const recentMessages = messages.slice(-10).reverse();
            
            recentMessages.forEach(msg => {
                messagesHTML += `
                    <div style="background: #f8f9ff; padding: 12px; margin-bottom: 8px; border-radius: 8px; border-left: 3px solid #667eea;">
                        <div style="font-size: 0.9rem; color: #4a5568; margin-bottom: 4px;">${msg.message}</div>
                        <div style="font-size: 0.75rem; color: #718096;">${msg.timestamp}</div>
                    </div>
                `;
            });
            
            container.innerHTML = messagesHTML;
        }

        // 감정 분석 및 일기 제출
        function submitDiary() {
            const diaryText = document.getElementById('diaryText').value.trim();
            
            if (!diaryText) {
                alert('마음을 적어주세요.');
                return;
            }
            
            updateLastVisit(); // 일기 쓰면 방문 시간 업데이트
            
            // 감정 분석
            const detectedEmotion = analyzeEmotion(diaryText);
            const responsiveCharacter = getResponsiveCharacter(detectedEmotion);
            
            // 일기 저장
            saveDiaryEntry(diaryText, detectedEmotion, responsiveCharacter);
            
            // 캐릭터 반응 표시
            showCharacterResponse(responsiveCharacter, diaryText);
        }

        // 강화된 감정 분석 함수
        function analyzeEmotion(text) {
            let maxScore = 0;
            let detectedEmotion = 'lonely'; // 기본값
            let detectedIntensity = 'medium';
            
            // 먼저 강화된 감정 시스템에서 검사
            Object.keys(enhancedEmotionSystem).forEach(emotion => {
                let score = 0;
                const emotionData = enhancedEmotionSystem[emotion];
                
                emotionData.keywords.forEach(keyword => {
                    if (text.includes(keyword)) {
                        // 강도별 가중치 적용
                        const intensityWeight = emotionData.intensity === 'high' ? 3 : 
                                              emotionData.intensity === 'medium' ? 2 : 1;
                        score += intensityWeight;
                    }
                });
                
                if (score > maxScore) {
                    maxScore = score;
                    detectedEmotion = emotion;
                    detectedIntensity = emotionData.intensity;
                }
            });
            
            // 강화된 시스템에서 감지되지 않으면 기본 시스템 사용
            if (maxScore === 0) {
                Object.keys(emotionResponses).forEach(emotion => {
                    let score = 0;
                    emotionResponses[emotion].keywords.forEach(keyword => {
                        if (text.includes(keyword)) {
                            score += 1;
                        }
                    });
                    
                    if (score > maxScore) {
                        maxScore = score;
                        detectedEmotion = emotion;
                        detectedIntensity = 'medium';
                    }
                });
            }
            
            return { emotion: detectedEmotion, intensity: detectedIntensity };
        }

        // 반응할 캐릭터 선택 (강화된 버전)
        function getResponsiveCharacter(emotionResult) {
            const emotion = typeof emotionResult === 'string' ? emotionResult : emotionResult.emotion;
            const intensity = typeof emotionResult === 'string' ? 'medium' : emotionResult.intensity;
            
            // 먼저 강화된 감정 시스템에서 찾기
            let emotionData = enhancedEmotionSystem[emotion];
            
            // 강화된 시스템에 없으면 기본 시스템 사용
            if (!emotionData) {
                emotionData = emotionResponses[emotion];
            }
            
            if (!emotionData) {
                // 감정 데이터가 없으면 기본 lonely 사용
                emotionData = emotionResponses['lonely'];
            }
            
            const characterId = emotionData.character;
            const response = emotionData.responses[Math.floor(Math.random() * emotionData.responses.length)];
            
            return {
                id: characterId,
                character: characters[characterId],
                response: response,
                emotion: emotion,
                intensity: intensity
            };
        }

        // 일기 저장 (강화된 버전)
        function saveDiaryEntry(text, emotionResult, characterResponse) {
            const timestamp = new Date().toLocaleString('ko-KR');
            const emotion = typeof emotionResult === 'string' ? emotionResult : emotionResult.emotion;
            const intensity = typeof emotionResult === 'string' ? 'medium' : emotionResult.intensity;
            
            const entry = {
                timestamp,
                text,
                emotion,
                intensity,
                character: characterResponse.character.name,
                response: characterResponse.response
            };
            
            let entries = JSON.parse(localStorage.getItem('diaryEntries') || '[]');
            entries.push(entry);
            
            // 최대 100개 일기만 보관
            if (entries.length > 100) {
                entries = entries.slice(-100);
            }
            
            localStorage.setItem('diaryEntries', JSON.stringify(entries));
        }

        // 캐릭터 반응 표시
        function showCharacterResponse(responsiveCharacter, originalText) {
            const character = responsiveCharacter.character;
            const response = responsiveCharacter.response;
            
            // 친밀도 증가 (일기 쓰면 +2)
            character.intimacy += 2;
            localStorage.setItem(`intimacy_${responsiveCharacter.id}`, character.intimacy.toString());
            
            const responseHTML = `
                <div class="result-section" style="margin-top: 20px; animation: fadeIn 0.5s ease-in;">
                    <div style="background: #f0f8ff; padding: 20px; border-radius: 15px; border-left: 4px solid #667eea; margin-bottom: 20px;">
                        <div style="text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 2rem; margin-bottom: 10px;">${character.emoji}</div>
                            <div style="font-size: 1.1rem; font-weight: bold; color: #4a5568;">${character.name}이 당신의 마음을 읽었어요</div>
                        </div>
                        
                        <div class="philosopher-quote" style="margin-bottom: 15px;">
                            <div class="quote">"${response}"</div>
                        </div>
                        
                        <div style="text-align: center; font-size: 0.9rem; color: #667eea;">
                            💕 ${character.name}와의 친밀도가 올라갔어요! (+2)
                            <br>현재 친밀도: ${'♥'.repeat(Math.min(character.intimacy, 10))} (${character.intimacy})
                        </div>
                    </div>
                    
                    <div style="text-align: center;">
                        <button class="action-button" onclick="meetCharacter('${responsiveCharacter.id}')" style="margin-right: 10px;">
                            ${character.emoji} ${character.name}와 더 깊이 대화하기
                        </button>
                        <button class="action-button" onclick="writeDiaryAgain()" style="background: #9f7aea;">
                            ✏️ 다른 마음도 적기
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('diaryResponse').innerHTML = responseHTML;
            
            // 입력창 비우기
            document.getElementById('diaryText').value = '';
        }

        // 일기 다시 쓰기
        function writeDiaryAgain() {
            document.getElementById('diaryResponse').innerHTML = '';
            document.getElementById('diaryText').focus();
        }

        // 마지막 방문 시간 업데이트
        function updateLastVisit() {
            localStorage.setItem('lastVisit', new Date().toISOString());
        }

        // 캐릭터 걱정 체크
        function checkCharacterConcerns() {
            const lastVisit = localStorage.getItem('lastVisit');
            const now = new Date();
            
            if (!lastVisit) {
                updateLastVisit();
                return;
            }
            
            const lastVisitDate = new Date(lastVisit);
            const daysDiff = Math.floor((now - lastVisitDate) / (1000 * 60 * 60 * 24));
            
            if (daysDiff <= 0) {
                hideCharacterNotification();
                return;
            }
            
            // 친밀도 높은 캐릭터부터 우선 체크
            const concernedCharacters = [];
            
            Object.keys(characters).forEach(charId => {
                const character = characters[charId];
                const concern = characterConcerns[charId];
                
                // 친밀도 5 이상이고, 해당 캐릭터의 threshold를 넘은 경우
                if (character.intimacy >= 5 && daysDiff >= concern.threshold) {
                    concernedCharacters.push({
                        id: charId,
                        character: character,
                        concern: concern,
                        intimacy: character.intimacy
                    });
                }
            });
            
            if (concernedCharacters.length > 0) {
                // 친밀도 가장 높은 캐릭터가 걱정 표시
                concernedCharacters.sort((a, b) => b.intimacy - a.intimacy);
                showCharacterConcern(concernedCharacters[0], daysDiff);
            } else {
                hideCharacterNotification();
            }
            
            updateLastVisit();
        }

        // 캐릭터 걱정 표시
        function showCharacterConcern(concernedChar, daysDiff) {
            const character = concernedChar.character;
            const concern = concernedChar.concern;
            const randomMessage = concern.messages[Math.floor(Math.random() * concern.messages.length)];
            
            const notificationHTML = `
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 2rem; margin-bottom: 10px;">${character.emoji}</div>
                    <div style="font-size: 1.1rem; font-weight: bold; color: #d69e2e; margin-bottom: 8px;">
                        ${character.name}이 당신을 걱정하고 있어요
                    </div>
                    <div style="font-size: 0.9rem; color: #975a16; margin-bottom: 12px;">
                        ${daysDiff}일 동안 만나지 못했어요
                    </div>
                    <div style="font-style: italic; color: #744210; margin-bottom: 15px;">
                        "${randomMessage}"
                    </div>
                    <button class="action-button" onclick="respondToConcern('${concernedChar.id}')" style="background: #f6ad55; color: #744210; padding: 8px 20px; font-size: 0.9rem;">
                        ${character.emoji} ${character.name}에게 안부 전하기
                    </button>
                </div>
            `;
            
            document.getElementById('notificationContent').innerHTML = notificationHTML;
            document.getElementById('characterNotification').style.display = 'block';
        }

        // 캐릭터 알림 숨기기
        function hideCharacterNotification() {
            document.getElementById('characterNotification').style.display = 'none';
        }

        // 걱정에 응답하기
        function respondToConcern(characterId) {
            hideCharacterNotification();
            meetCharacter(characterId);
            
            // 걱정에 응답했으므로 친밀도 보너스 +1
            const character = characters[characterId];
            character.intimacy += 1;
            localStorage.setItem(`intimacy_${characterId}`, character.intimacy.toString());
        }

        // 사용자 히스토리 분석
        function analyzeUserHistory(characterId) {
            const diaryEntries = JSON.parse(localStorage.getItem('diaryEntries') || '[]');
            const companionMeetings = JSON.parse(localStorage.getItem('companionMeetings') || '[]');
            
            // 최근 7일 이내의 데이터만 분석
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            
            const recentDiaries = diaryEntries.filter(entry => 
                new Date(entry.timestamp) > sevenDaysAgo
            );
            
            const recentMeetings = companionMeetings.filter(meeting => 
                new Date(meeting.timestamp) > sevenDaysAgo
            );
            
            // 감정 패턴 분석
            const emotionCounts = {};
            recentDiaries.forEach(entry => {
                emotionCounts[entry.emotion] = (emotionCounts[entry.emotion] || 0) + 1;
            });
            
            const mostFrequentEmotion = Object.keys(emotionCounts).reduce((a, b) => 
                emotionCounts[a] > emotionCounts[b] ? a : b, 'lonely'
            );
            
            // 마지막 일기 분석
            const lastDiary = recentDiaries.length > 0 ? recentDiaries[recentDiaries.length - 1] : null;
            
            // 해당 캐릭터와의 마지막 만남
            const lastMeetingWithCharacter = recentMeetings
                .filter(meeting => meeting.companion === characters[characterId].name)
                .pop();
            
            // 시간대 패턴 분석
            const visitTimes = recentDiaries.map(entry => new Date(entry.timestamp).getHours());
            const avgVisitTime = visitTimes.length > 0 ? 
                Math.round(visitTimes.reduce((a, b) => a + b, 0) / visitTimes.length) : 12;
            
            return {
                mostFrequentEmotion,
                lastDiary,
                lastMeetingWithCharacter,
                recentDiariesCount: recentDiaries.length,
                avgVisitTime,
                emotionCounts
            };
        }

        // 개인화된 대화 생성
        function getPersonalizedDialogue(character, userHistory) {
            const characterId = Object.keys(characters).find(id => characters[id] === character);
            
            // 특별한 날 체크
            const specialOccasions = checkSpecialOccasions(characterId, character);
            
            // 시간 패턴 분석
            const timePatterns = analyzeTimePatterns();
            
            // 관계 진화 단계 확인
            const evolution = relationshipEvolution[characterId];
            let evolvedDialogue = null;
            
            if (evolution) {
                const evolutionLevels = Object.keys(evolution).map(Number).sort((a, b) => b - a);
                for (let level of evolutionLevels) {
                    if (character.intimacy >= level) {
                        evolvedDialogue = evolution[level];
                        break;
                    }
                }
            }
            
            // 기본 친밀도별 대화
            let baseDialogue = character.dialogues[0];
            const intimacyLevels = Object.keys(character.dialogues).map(Number).sort((a, b) => b - a);
            for (let level of intimacyLevels) {
                if (character.intimacy >= level) {
                    baseDialogue = character.dialogues[level];
                    break;
                }
            }
            
            // 개인화된 인사말 생성 (진화된 관계면 진화된 인사말 사용)
            let personalizedGreeting = evolvedDialogue ? evolvedDialogue.greeting : baseDialogue.greeting;
            
            // 시간대 맞춤 인사말 추가
            if (timePatterns && character.intimacy >= 15) {
                const currentHour = new Date().getHours();
                if (Math.abs(currentHour - timePatterns.mostActiveHour) <= 1) {
                    personalizedGreeting += ` 평소처럼 ${timePatterns.mostActiveHour}시경에 오셨네요.`;
                } else if (currentHour < 6 || currentHour > 23) {
                    personalizedGreeting += ` 이른 시간에 오셨네요. 잠 못 이루시나요?`;
                }
            }
            
            // 마지막 일기 기반 맥락적 대화
            let contextualMessage = '';
            if (userHistory.lastDiary && character.intimacy >= 5) {
                const daysSinceLastDiary = Math.floor(
                    (new Date() - new Date(userHistory.lastDiary.timestamp)) / (1000 * 60 * 60 * 24)
                );
                
                if (daysSinceLastDiary <= 2) {
                    contextualMessage = generateContextualMessage(character.name, userHistory.lastDiary, daysSinceLastDiary);
                }
            }
            
            // 감정 패턴 기반 조언
            let patternAdvice = '';
            if (character.intimacy >= 10 && userHistory.recentDiariesCount >= 3) {
                patternAdvice = generatePatternAdvice(character.name, userHistory.mostFrequentEmotion, userHistory.emotionCounts);
            }
            
            // 진화된 관계의 특별 메시지
            let evolutionMessage = '';
            if (evolvedDialogue && character.intimacy >= 20) {
                const randomSpecialMessage = evolvedDialogue.specialMessages[
                    Math.floor(Math.random() * evolvedDialogue.specialMessages.length)
                ];
                evolutionMessage = randomSpecialMessage;
            }
            
            return {
                ...baseDialogue,
                greeting: personalizedGreeting,
                contextualMessage,
                patternAdvice,
                specialOccasions,
                timePatterns,
                evolutionMessage,
                evolvedTone: evolvedDialogue ? evolvedDialogue.tone : null
            };
        }

        // 맥락적 메시지 생성
        function generateContextualMessage(characterName, lastDiary, daysSince) {
            const emotionResponses = {
                bada: {
                    tired: daysSince === 0 ? 
                        "아까 피곤하다고 하셨는데, 조금 나아지셨나요?" :
                        `${daysSince}일 전에 피곤하다고 하셨는데, 좀 쉬셨나요?`,
                    sad: daysSince === 0 ? 
                        "아까 마음이 아프다고 하셨죠. 지금은 어떠세요?" :
                        `${daysSince}일 전에 슬픈 마음을 털어놓으셨는데, 조금 괜찮아지셨나요?`,
                    anxious: daysSince === 0 ?
                        "아까 불안하다고 하셨는데, 마음이 좀 진정되셨나요?" :
                        `${daysSince}일 전에 불안해하셨는데, 지금은 어떠세요?`
                },
                quest: {
                    confused: daysSince === 0 ?
                        "아까 혼란스럽다고 하셨는데, 조금 정리가 되셨나요?" :
                        `${daysSince}일 전에 혼란스러워하셨는데, 답을 찾으셨나요?`,
                    tired: daysSince === 0 ?
                        "아까 힘들다고 하셨는데, 그 원인에 대해 더 생각해보셨나요?" :
                        `${daysSince}일 전에 피곤하다고 하셨는데, 왜 그랬을까 생각해보셨나요?`
                },
                flame: {
                    angry: daysSince === 0 ?
                        "아까 화가 난다고 하셨는데, 그 에너지를 어떻게 사용하셨나요?" :
                        `${daysSince}일 전에 화가 나셨는데, 그걸 극복하는 과정은 어땠나요?`,
                    tired: daysSince === 0 ?
                        "아까 지쳤다고 하셨는데, 다시 일어설 준비가 되셨나요?" :
                        `${daysSince}일 전에 힘들어하셨는데, 더 강해지셨나요?`
                }
            };
            
            const characterResponses = emotionResponses[characterName] || {};
            return characterResponses[lastDiary.emotion] || '';
        }

        // 패턴 기반 조언 생성
        function generatePatternAdvice(characterName, mostFrequentEmotion, emotionCounts) {
            const patternResponses = {
                bada: {
                    tired: "최근에 자주 피곤해하시는 것 같아요. 마음의 휴식이 필요한 시점인 것 같습니다.",
                    sad: "요즘 마음이 많이 아프신 것 같아요. 슬픔도 자연스러운 과정이니 천천히 받아들여보세요.",
                    lonely: "혼자라는 느낌을 자주 느끼시는군요. 하지만 지금 여기 제가 함께 있어요."
                },
                quest: {
                    confused: "최근에 혼란스러운 일이 많으셨군요. 하나씩 차근차근 탐구해나가면 답이 보일 거예요.",
                    anxious: "불안한 마음이 자주 드시는 것 같아요. 그 불안의 뿌리를 함께 찾아봐요."
                },
                flame: {
                    angry: "화가 나는 일이 많으셨군요. 그 감정을 성장의 에너지로 바꿔보는 건 어떨까요?",
                    tired: "자주 지치시는군요. 더 강해지기 위한 과정일 수도 있어요. 포기하지 마세요."
                }
            };
            
            const characterPatterns = patternResponses[characterName] || {};
            return characterPatterns[mostFrequentEmotion] || '';
        }

        // 함께 시간 보내기 관련 변수들
        let ambientTimer = null;
        let ambientStartTime = null;
        let ambientMessageTimer = null;
        let currentAmbientCharacter = null;

        // 함께 시간 보내기 시작
        function startAmbientTime(characterId) {
            hideAllContent();
            document.getElementById('ambientTime').classList.add('active');
            
            const character = characters[characterId];
            currentAmbientCharacter = characterId;
            
            // UI 업데이트
            document.getElementById('ambientCharacterName').textContent = `${character.emoji} ${character.name}와 함께`;
            document.getElementById('ambientCharacterDesc').textContent = `${character.themeMusic.description}`;
            document.getElementById('ambientCharacterEmoji').textContent = character.emoji;
            document.getElementById('ambientMusicTitle').textContent = `🎵 ${character.themeMusic.title}`;
            document.getElementById('ambientMusicDesc').textContent = character.themeMusic.description;
            document.getElementById('ambientMusicLink').href = character.themeMusic.url;
            
            // 타이머 시작
            ambientStartTime = new Date();
            startAmbientTimer();
            
            // 첫 메시지 표시
            showAmbientMessage(characterId);
            
            // 주기적 메시지 시작 (3-7분 간격)
            scheduleNextAmbientMessage(characterId);
            
            // 친밀도 증가 (+1, 조용히)
            character.intimacy += 1;
            localStorage.setItem(`intimacy_${characterId}`, character.intimacy.toString());
            
            updateLastVisit();
        }

        // 함께 시간 보내기 종료
        function leaveAmbientTime() {
            clearInterval(ambientTimer);
            clearTimeout(ambientMessageTimer);
            
            // 마지막 메시지
            if (currentAmbientCharacter) {
                const character = characters[currentAmbientCharacter];
                const timeSpent = Math.floor((new Date() - ambientStartTime) / 1000 / 60);
                
                if (timeSpent >= 3) {
                    const farewellMessages = [
                        `${timeSpent}분 동안 함께해줘서 고마웠어요. 언제든 다시 와주세요.`,
                        `함께한 이 시간이 당신에게 작은 위로가 되었길 바라요.`,
                        `조용히 함께 있어줘서 고마웠어요. 또 만나요.`
                    ];
                    const farewell = farewellMessages[Math.floor(Math.random() * farewellMessages.length)];
                    
                    alert(`${character.emoji} ${character.name}: "${farewell}"`);
                }
            }
            
            showMainMenu();
        }

        // 타이머 업데이트
        function startAmbientTimer() {
            ambientTimer = setInterval(() => {
                const elapsed = new Date() - ambientStartTime;
                const minutes = Math.floor(elapsed / 1000 / 60);
                const seconds = Math.floor((elapsed / 1000) % 60);
                
                document.getElementById('ambientTimer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        // 환경 메시지 표시
        function showAmbientMessage(characterId) {
            const character = characters[characterId];
            const randomMessage = character.ambientMessages[
                Math.floor(Math.random() * character.ambientMessages.length)
            ];
            
            const messageElement = document.getElementById('ambientMessage');
            messageElement.style.opacity = '0';
            
            setTimeout(() => {
                messageElement.textContent = randomMessage;
                messageElement.style.opacity = '1';
            }, 300);
        }

        // 다음 메시지 스케줄링
        function scheduleNextAmbientMessage(characterId) {
            // 3-7분 사이 랜덤 간격
            const interval = (3 + Math.random() * 4) * 60 * 1000;
            
            ambientMessageTimer = setTimeout(() => {
                showAmbientMessage(characterId);
                scheduleNextAmbientMessage(characterId); // 다음 메시지 스케줄
            }, interval);
        }

        // 일상 발견 불러오기
        function loadNewDiscoveries() {
            const container = document.getElementById('discoveryContainer');
            const currentHour = new Date().getHours();
            
            // 시간대 결정
            let timeOfDay;
            if (currentHour >= 5 && currentHour < 12) {
                timeOfDay = 'morning';
            } else if (currentHour >= 12 && currentHour < 18) {
                timeOfDay = 'afternoon';
            } else {
                timeOfDay = 'evening';
            }
            
            // 각 캐릭터에서 랜덤하게 하나씩 선택
            let discoveriesHTML = '';
            const characterOrder = Object.keys(characters);
            
            // 친밀도 높은 순으로 정렬
            characterOrder.sort((a, b) => characters[b].intimacy - characters[a].intimacy);
            
            characterOrder.forEach(charId => {
                const character = characters[charId];
                const discoveries = character.dailyDiscoveries[timeOfDay];
                const randomDiscovery = discoveries[Math.floor(Math.random() * discoveries.length)];
                
                // 친밀도에 따른 표시 여부 결정
                const shouldShow = character.intimacy >= 3 || Math.random() < 0.3;
                
                if (shouldShow) {
                    discoveriesHTML += `
                        <div class="pattern-item" style="margin-bottom: 20px; position: relative;">
                            <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                <div style="font-size: 2rem; margin-right: 15px;">${character.emoji}</div>
                                <div>
                                    <div style="font-weight: bold; color: #4a5568; font-size: 1.1rem;">${character.name}</div>
                                    <div style="color: #718096; font-size: 0.9rem;">${character.type}</div>
                                    ${character.intimacy >= 5 ? `<div style="color: #e53e3e; font-size: 0.8rem;">♥ 친밀도 ${character.intimacy}</div>` : ''}
                                </div>
                            </div>
                            
                            <div style="background: #f8f9ff; padding: 15px; border-radius: 10px; font-style: italic; color: #4a5568; line-height: 1.6;">
                                "${randomDiscovery}"
                            </div>
                            
                            ${character.intimacy >= 5 ? `
                                <div style="text-align: right; margin-top: 10px;">
                                    <button class="action-button" onclick="meetCharacter('${charId}')" style="padding: 8px 15px; font-size: 0.9rem;">
                                        ${character.emoji} ${character.name}와 대화하기
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
            });
            
            // 시간대별 헤더 추가
            const timeHeaders = {
                morning: '🌅 아침의 발견들',
                afternoon: '☀️ 오후의 발견들', 
                evening: '🌙 저녁의 발견들'
            };
            
            const finalHTML = `
                <div style="text-align: center; margin-bottom: 25px; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px;">
                    <h2 style="margin: 0; font-size: 1.3rem;">${timeHeaders[timeOfDay]}</h2>
                    <p style="margin: 5px 0 0 0; font-size: 0.9rem; opacity: 0.9;">캐릭터들이 오늘 ${timeOfDay === 'morning' ? '아침' : timeOfDay === 'afternoon' ? '오후' : '저녁'}에 경험한 이야기들</p>
                </div>
                ${discoveriesHTML}
            `;
            
            container.innerHTML = finalHTML;
            
            // 발견 기록 저장
            saveDailyDiscoveryViewing(timeOfDay);
        }

        // 일상 발견 보기 기록
        function saveDailyDiscoveryViewing(timeOfDay) {
            const today = new Date().toDateString();
            const viewKey = `discoveryViewed_${today}_${timeOfDay}`;
            localStorage.setItem(viewKey, 'true');
        }

        // 페이지 로드 시 초기화
        window.onload = function() {
            checkCharacterConcerns();
        };
    </script>
</body>
</html>